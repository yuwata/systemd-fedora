From b7c3e723d0f3c3f811e23e21b2ba3fdc5399f64d Mon Sep 17 00:00:00 2001
From: Yu Watanabe <watanabe.yu+github@gmail.com>
Date: Mon, 23 Nov 2020 13:44:29 +0900
Subject: [PATCH] network: simplify the condition about ipv4ll is enabled or
 not

---
 src/network/networkd-dhcp4.c | 18 ++++++------------
 src/network/networkd-link.c  |  4 +---
 2 files changed, 7 insertions(+), 15 deletions(-)

diff --git a/src/network/networkd-dhcp4.c b/src/network/networkd-dhcp4.c
index 9fb1274067..2ad1297c02 100644
--- a/src/network/networkd-dhcp4.c
+++ b/src/network/networkd-dhcp4.c
@@ -1048,9 +1048,7 @@ static int dhcp4_handler(sd_dhcp_client *client, int event, void *userdata) {
 
         switch (event) {
                 case SD_DHCP_CLIENT_EVENT_STOP:
-                        if (link_ipv4ll_enabled(link)) {
-                                assert(link->ipv4ll);
-
+                        if (link->ipv4ll) {
                                 log_link_debug(link, "DHCP client is stopped. Acquiring IPv4 link-local address");
 
                                 r = sd_ipv4ll_start(link->ipv4ll);
@@ -1154,16 +1152,12 @@ static int dhcp4_handler(sd_dhcp_client *client, int event, void *userdata) {
                         break;
 
                 case SD_DHCP_CLIENT_EVENT_TRANSIENT_FAILURE:
-                        if (link_ipv4ll_enabled(link)) {
-                                assert(link->ipv4ll);
+                        if (link->ipv4ll && !sd_ipv4ll_is_running(link->ipv4ll)) {
+                                log_link_debug(link, "Problems acquiring DHCP lease, acquiring IPv4 link-local address");
 
-                                if (!sd_ipv4ll_is_running(link->ipv4ll)) {
-                                        log_link_debug(link, "Problems acquiring DHCP lease, acquiring IPv4 link-local address");
-
-                                        r = sd_ipv4ll_start(link->ipv4ll);
-                                        if (r < 0)
-                                                return log_link_warning_errno(link, r, "Could not acquire IPv4 link-local address: %m");
-                                }
+                                r = sd_ipv4ll_start(link->ipv4ll);
+                                if (r < 0)
+                                        return log_link_warning_errno(link, r, "Could not acquire IPv4 link-local address: %m");
                         }
                         break;
 
diff --git a/src/network/networkd-link.c b/src/network/networkd-link.c
index d55ec69514..6962e622d3 100644
--- a/src/network/networkd-link.c
+++ b/src/network/networkd-link.c
@@ -1207,9 +1207,7 @@ static int link_acquire_ipv4_conf(Link *link) {
                 if (r < 0)
                         return log_link_warning_errno(link, r, "Could not acquire DHCPv4 lease: %m");
 
-        } else if (link_ipv4ll_enabled(link)) {
-                assert(link->ipv4ll);
-
+        } else if (link->ipv4ll) {
                 log_link_debug(link, "Acquiring IPv4 link-local address");
 
                 r = sd_ipv4ll_start(link->ipv4ll);
