From 3c4d62f8cff67610e224898d97a15dcf6da2ddbe Mon Sep 17 00:00:00 2001
From: Yu Watanabe <watanabe.yu+github@gmail.com>
Date: Tue, 17 Nov 2020 09:13:59 +0900
Subject: [PATCH] core/mount: mount command may fail after adding the
 corresponding proc mountinfo entry

Hopefully fixes #17617.
---
 src/core/mount.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/core/mount.c b/src/core/mount.c
index 41dc7e9967..e3a7da4941 100644
--- a/src/core/mount.c
+++ b/src/core/mount.c
@@ -1948,6 +1948,16 @@ static int mount_process_proc_self_mountinfo(Manager *m) {
                                 mount_enter_dead(mount, MOUNT_SUCCESS);
                                 break;
 
+                        case MOUNT_MOUNTING_DONE:
+                                /* The mount command may once add the corresponding proc mountinfo
+                                 * entry and then remove it because of an internal error. E.g.,
+                                 * fuse.sshfs seems to do that when the connection fails. See #17617.
+                                 * To handle such the case, let's once set the state back to mounting.
+                                 * Then, the unit can correctly enter the failed state later in
+                                 * mount_sigchld(). */
+                                mount_set_state(mount, MOUNT_MOUNTING);
+                                break;
+
                         default:
                                 break;
                         }
