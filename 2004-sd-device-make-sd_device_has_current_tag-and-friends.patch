From a41bdc55bbb7a07493f6080772da55c5d56af9de Mon Sep 17 00:00:00 2001
From: Yu Watanabe <watanabe.yu+github@gmail.com>
Date: Mon, 16 Nov 2020 19:47:42 +0900
Subject: [PATCH] sd-device: make sd_device_has_current_tag() and friends
 compatible with udev database generated by old udevd

---
 src/libsystemd/sd-device/sd-device.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/src/libsystemd/sd-device/sd-device.c b/src/libsystemd/sd-device/sd-device.c
index e895b7818a..033165f87c 100644
--- a/src/libsystemd/sd-device/sd-device.c
+++ b/src/libsystemd/sd-device/sd-device.c
@@ -1443,6 +1443,12 @@ _public_ const char *sd_device_get_current_tag_first(sd_device *device) {
 
         assert_return(device, NULL);
 
+        /* Both the current tag and UDEV_VERSION property are implemented in v247. So, it is safe to
+         * check only the existence of the property. If the udev database is created by udevd older
+         * than v247, then the tags (NOT current_tags) are not sticky. */
+        if (!ordered_hashmap_contains(device->properties, "UDEV_VERSION"))
+                return sd_device_get_tag_first(device);
+
         (void) device_read_db(device);
 
         device->current_tags_iterator_generation = device->tags_generation;
@@ -1457,6 +1463,12 @@ _public_ const char *sd_device_get_current_tag_next(sd_device *device) {
 
         assert_return(device, NULL);
 
+        /* Both the current tag and UDEV_VERSION property are implemented in v247. So, it is safe to
+         * check only the existence of the property. If the udev database is created by udevd older
+         * than v247, then the tags (NOT current_tags) are not sticky. */
+        if (!ordered_hashmap_contains(device->properties, "UDEV_VERSION"))
+                return sd_device_get_tag_next(device);
+
         (void) device_read_db(device);
 
         if (device->current_tags_iterator_generation != device->tags_generation)
@@ -1759,6 +1771,12 @@ _public_ int sd_device_has_current_tag(sd_device *device, const char *tag) {
         assert_return(device, -EINVAL);
         assert_return(tag, -EINVAL);
 
+        /* Both the current tag and UDEV_VERSION property are implemented in v247. So, it is safe to
+         * check only the existence of the property. If the udev database is created by udevd older
+         * than v247, then the tags (NOT current_tags) are not sticky. */
+        if (!ordered_hashmap_contains(device->properties, "UDEV_VERSION"))
+                return sd_device_has_tag(device, tag);
+
         (void) device_read_db(device);
 
         return set_contains(device->current_tags, tag);
